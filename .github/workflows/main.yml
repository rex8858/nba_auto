name: NBA Auto Tasks (Hybrid v4.3)

on:
  workflow_dispatch:        # âœ… æ‰‹å‹•åŸ·è¡Œ
  schedule:
    - cron: '30 23 * * *'   # æ¯å¤©å°åŒ—æ—©ä¸Š 7:30ï¼ˆET æ™šä¸Š 18:30ï¼‰
    - cron: '0 0 * * *'     # æ¯å¤©å°åŒ—æ—©ä¸Š 8:00 å†æ¬¡æª¢æŸ¥

permissions:
  contents: write           # âœ… çµ¦ GitHub Actions å¯«å…¥æ¬Šé™

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡º GitHub å°ˆæ¡ˆ
      uses: actions/checkout@v3
      with:
        fetch-depth: 0      # âœ… å…è¨±å­˜å–å®Œæ•´æäº¤ç´€éŒ„èˆ‡ data/

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy pytz pyyaml requests

    - name: åŸ·è¡Œ NBA Hybrid v4.x è‡ªå‹•é æ¸¬èˆ‡å›æŠ“
      run: |
        echo "ğŸ•’ Starting NBA Hybrid v4.3 automation..."
        python main.py

    # âœ… è‹¥èƒ½ç›´æ¥ pushï¼ˆrepo ç„¡ä¿è­·ï¼‰ï¼Œå‰‡ç”¨é€™æ®µ
    - name: è‡ªå‹•ä¸Šå‚³æ›´æ–°æª”æ¡ˆè‡³ GitHub (æ›´æ–°è³‡æ–™)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add logs/ || true
        git commit -m "Auto update: logs and predictions [Hybrid v4.3]" || echo "No direct changes to commit"
        git push || echo "âš ï¸ Direct push failed, will create PR instead"

    # âœ… è‹¥ç„¡æ³• pushï¼ˆä¾‹å¦‚ main æœ‰ä¿è­·ï¼‰ï¼Œè‡ªå‹•å»ºç«‹ Pull Request
    - name: å»ºç«‹ Pull Request å‚™æ´
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Auto update: logs & backups [Hybrid v4.3]"
        title: "Auto update (logs & backups)"
        body: |
          ğŸ“Š This PR contains auto-generated data updates:
          - Latest predictions & logs from Hybrid v4.3
          - Backups included
          - Created automatically by GitHub Actions
        branch: auto/update-logs
        base: main

    - name: å»ºç«‹æ¯æ—¥ ZIP å‚™ä»½
      run: |
        mkdir -p backups
        zip -r backups/nba_auto_backup_$(date +'%Y%m%d_%H%M').zip data logs
        git add backups/ || true
        git commit -m "Add daily backup zip [Hybrid v4.3]" || echo "No new backups"
        git push || echo "âš ï¸ Backup push failed; PR already covers changes"

