name: NBA Auto Tasks (Hybrid v4.3)

on:
  schedule:
    - cron: '0 22 * * *'   # 台北06:00 T120
    - cron: '30 0 * * *'   # 台北08:30 T60A
    - cron: '30 1 * * *'   # 台北09:30 T60B
    - cron: '0 11 * * *'   # 台北19:00 evening
  workflow_dispatch:
    inputs:
      which:
        description: "Run which task? (t120/t60a/t60b/evening/all)"
        required: false
        default: "all"

concurrency:
  group: nba-auto-main
  cancel-in-progress: false

jobs:
  run-task:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        task:
          - { name: "t120",   cmd: "python main.py --task morning --snapshot T120 --tz Asia/Taipei",  msg: "Auto: T120 snapshot (Hybrid v4.3)" }
          - { name: "t60a",   cmd: "python main.py --task morning --snapshot T60 --tz Asia/Taipei",   msg: "Auto: T60 batch A (Hybrid v4.3)" }
          - { name: "t60b",   cmd: "python main.py --task morning --snapshot T60 --tz Asia/Taipei",   msg: "Auto: T60 batch B (Hybrid v4.3)" }
          - { name: "evening",cmd: "python main.py --task evening --tz Asia/Taipei",                  msg: "Auto: nightly backfill (Hybrid v4.3)" }

    # ✅ 自動模式四個依序跑；手動模式只跑選到的或依序執行 all
    if: >
      ${{
        (github.event_name == 'workflow_dispatch' &&
         (inputs.which == 'all' || matrix.task.name == inputs.which))
        || (github.event_name == 'schedule')
      }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          mkdir -p data logs backups

      - name: Run NBA Hybrid v4.3 automation
        run: ${{ matrix.task.cmd }}

      - name: Commit & push updates safely
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git pull --rebase origin main
          git add data logs || true
          git diff --cached --quiet && echo "No changes to commit" && exit 0 || true
          git commit -m "${{ matrix.task.msg }}" || echo "no changes"
          n=0
          until [ $n -ge 3 ]
          do
            git pull --rebase origin main && git push origin main && break
            n=$((n+1))
            echo "Retry push ($n/3)..."
            sleep 5
          done

      - name: Zip nightly backup (only for evening)
        if: matrix.task.name == 'evening'
        run: |
          ts=$(date +'%Y%m%d_%H%M')
          mkdir -p backups
          zip -r backups/nba_auto_backup_${ts}.zip data logs || true
          git fetch origin main
          git checkout main
          git pull --rebase origin main
          git add backups || true
          git diff --cached --quiet && echo "No zip to commit" && exit 0 || true
          git commit -m "Add nightly backup zip (Hybrid v4.3)" || echo "no zip changes"
          git push origin main
