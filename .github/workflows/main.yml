name: NBA Auto Predictor (Hybrid v4.3 – Final Stable Rolling Coverage)

on:
  schedule:
    # 早上 Live 預測（台北時間 06:45–10:45，每半小時一次）
    # 這裡的時間都是 UTC，要 +8 才是台北時間
    - cron: '45 22,23,0,1,2 * * *'   # :45 → 06:45, 07:45, 08:45, 09:45, 10:45 (Asia/Taipei)
    - cron: '15 23,0,1,2 * * *'      # :15 → 07:15, 08:15, 09:15, 10:15 (Asia/Taipei)

    # 每天台北 19:00 做昨日 Backfill（UTC 11:00）
    - cron: '0 11 * * *'

  workflow_dispatch:
    inputs:
      which:
        description: "Run which task? (live/backfill/all)"
        required: false
        default: "all"

# 確保同一時間只跑一個 workflow，不會打架
concurrency:
  group: nba-auto-predictor
  cancel-in-progress: false

jobs:
  run-task:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        task:
          - { name: "live",
              cmd: "python main.py --task morning --mode live --tz Asia/Taipei",
              msg: "Auto: Rolling live snapshot (Hybrid v4.3)" }
          - { name: "backfill",
              cmd: "python main.py --task evening --mode backfill --tz Asia/Taipei",
              msg: "Auto: nightly backfill (Hybrid v4.3)" }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 需要完整 git 歷史，rebase 比較安全

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          mkdir -p data logs backups

      - name: Run NBA Hybrid v4.3 automation
        if: github.event_name == 'schedule' || inputs.which == 'all' || matrix.task.name == inputs.which
        run: |
          echo "Running task: ${{ matrix.task.name }}"
          echo "Command: ${{ matrix.task.cmd }}"
          ${{ matrix.task.cmd }}

      - name: Commit & push updates safely
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase || echo "no rebase needed"
          git add data logs || true
          git commit -m "${{ matrix.task.msg }}" || echo "no changes"
          git push origin HEAD || echo "nothing to push"

      - name: Zip nightly backup (only for backfill)
        if: matrix.task.name == 'backfill'
        run: |
          ts=$(date +'%Y%m%d_%H%M')
          mkdir -p backups
          zip -r backups/nba_auto_backup_${ts}.zip data logs || true

          git pull --rebase || true
          git add backups || true
          git commit -m "Add nightly backup zip (Hybrid v4.3)" || echo "no zip changes"
          git push origin HEAD || echo "no backup to push"
